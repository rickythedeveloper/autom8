<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Edit scheme</title>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="main.css">
</head>
<body style="background: white;">

    <button id="home" onClick="goToHome()">Home</button>
    <h1 id="schemeName">Scheme name</h1>
    <main class='row'>
        <div class="col-8">
            <div id="processes"></div>
            <div>
                <button onclick="runScheme()">Run</button>
            </div>
            <a href="https://bbc.co.uk" target='_blank'>bbc man</a>

            <div class="modal fade" id="editVariableModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Variable</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="mb-3">
                                    <label for="variable-name" class="col-form-label">Name:</label>
                                    <input type="text" class="form-control" id="input-variable-name">
                                </div>
                                <div class="mb-3">
                                    <label for="variable-value" class="col-form-label">Initial Value:</label>
                                    <input type="text" class="form-control" id="input-variable-value">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <p>hello</p>
        </div>
    </main>

    <script>require('bootstrap')</script>
</body>

<script>
    const { ipcRenderer } = require('electron')

    // get the scheme id
    const schemeID = getSchemeId()

    // based on the reply to the data request with scheme id, complete html
    ipcRenderer.on('requestSchemeData-reply', (event, schemeData) => {
        setupPage(schemeData)
    })

    // request all the data with the id obtained
    ipcRenderer.send('requestSchemeData', schemeID)

    function getSchemeId() {
        const querystring = require('querystring');
        let query = querystring.parse(global.location.search);
        if (query == null) {
            console.log('No scheme id found (no query was completed when edit scheme page opened')
        }
        if ('?schemeID' in query) {
            return query['?schemeID']
        } else {
            console.log('No scheme id found (query does not contain scheme id')
            return null
        }
    }

    function setupPage(schemeData) {
        setSchemeName(schemeData)
        addProcessElems(schemeData)
        addVariableElems(schemeData)
        dealWithVariableModal()
    }

    function setSchemeName(schemeData) {
        schemeNameElem = document.getElementById('schemeName')
        schemeNameElem.innerHTML = schemeData.schemeName
    }

    function addProcessElems(schemeData) {
        processesElem = document.getElementById('processes')
        processes = schemeData.processes
        for (process of processes) {
            var processElem = document.createElement('div')
            processElem.innerHTML = process.data['processName']
            // setOnClick(processElem, process)
            processElem.style.backgroundColor = 'red'
            processElem.id = process.data.id
            processesElem.appendChild(processElem)
        }
    }

    function addVariableElems(schemeData) {
        for (process  of schemeData.processes) {
            nInputs = process.data.processType.nInputs
            nOutputs = process.data.processType.nOutputs

            // create inputs wrapper
            inputWrapper = document.createElement('div')
            inputWrapper.className = 'input-wrapper row'
            inputWidth = nInputs <= 0 ? 0 : (nInputs < 4 ? 12/nInputs : 3)

            // put each input in a col
            for (inputVar of process.data.inputVars) {
                column = document.createElement('div')
                colClass = 'col-' + inputWidth
                column.className = colClass
                varElem = variableElem(inputVar)
                column.appendChild(varElem)
                inputWrapper.appendChild(column)
            }

            // create outputs wrapper
            outputWrapper = document.createElement('div')
            outputWrapper.className = 'output-wrapper row'
            outputWidth = nOutputs <= 0 ? 0 : (nOutputs < 4 ? 12/nOutputs : 3)

            // put each output in a col
            for (outputVar of process.data.outputVars) {
                column = document.createElement('div')
                colClass = 'col-' + outputWidth
                column.className = colClass
                varElem = variableElem(outputVar)
                column.appendChild(varElem)
                outputWrapper.appendChild(column)
            }

            processElem = document.getElementById(process.data.id)
            processElem.parentNode.insertBefore(inputWrapper, processElem)
            insertAfter(processElem, outputWrapper)
        }
    }

    function insertAfter(referenceNode, newNode) {
        referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
    }

    function variableElem(variable) {
        const vName = variable.data.name
        const vValue = variable.data.value
        elem = document.createElement('div')
        elem.textContent = vName //+ '\n(' + vValue + ')'
        elem.className = 'variable'
        elem.setAttribute('data-variable-name', vName)
        elem.setAttribute('data-variable-value', vValue)
        elem.setAttribute('data-bs-toggle', 'modal')
        elem.setAttribute('data-bs-target', '#editVariableModal')
        return elem
    }

    function dealWithVariableModal() {
            var editVariableModal = document.getElementById('editVariableModal')
            editVariableModal.addEventListener('show.bs.modal', function (event) {
                var elem = event.relatedTarget
                var vName = elem.getAttribute('data-variable-name')
                var vValue = elem.getAttribute('data-variable-value')
                var vNameELem = editVariableModal.querySelector('.modal-body #input-variable-name')
                var vValueElem = editVariableModal.querySelector('.modal-body #input-variable-value')
                vNameELem.value = vName
                vValueElem.value = vValue
            })
        }

    // function setOnClick(element, process) {
    //     element.onclick = function() {
    //         process.runProcess()
    //     }
    // }

    function runScheme() {
        ipcRenderer.send('runScheme', schemeID)
    }

    function goToHome() {
        ipcRenderer.send('goToHome')
    }

</script>

</html>